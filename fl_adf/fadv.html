<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Filter & Browser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #666;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .filter-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 0 20px;
            max-height: 40vh;
            overflow-y: auto;
        }

        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .save-load-controls {
            display: flex;
            gap: 10px;
        }

        .save-btn, .load-btn, .clear-btn {
            background: linear-gradient(45deg, #6f42c1, #8a2be2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .save-btn:hover, .load-btn:hover, .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
        }

        .clear-btn {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .add-filter-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }

        .add-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .filter-set {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .filter-set:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .filter-set-header {
            background: linear-gradient(45deg, #495057, #6c757d);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-set-title {
            flex: 1;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .logic-dropdown {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #333;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .logic-dropdown option {
            background: white;
            color: #333;
            padding: 5px;
        }
        
        .filter-set-header .logic-dropdown {
            background: rgba(255, 255, 255, 0.85);
            color: #2c3e50;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .filter-set-header .logic-dropdown:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .remove-filter-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .remove-filter-btn:hover {
            background: #c82333;
        }

        .filter-set-content {
            padding: 20px;
        }

        .subcategory {
            margin-bottom: 25px;
        }

        .subcategory-title {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .code-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .code-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            user-select: none;
        }

        .code-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .code-btn.maybe {
            background: #6c757d;
            color: white;
            border-color: #5a6268;
        }

        .code-btn.yes {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .code-btn.no {
            background: #dc3545;
            color: white;
            border-color: #bd2130;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3);
        }

        .logic-connector {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            color: #495057;
            background: linear-gradient(90deg, transparent, #f8f9fa, transparent);
        }

        .results-panel {
            padding: 20px;
            background: white;
            margin: 0 20px;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }

        .results-header {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-radius: 15px 15px 0 0;
        }
        
        .results-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .results-count {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .pagination-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px 0;
        }
        
        .pagination-btn {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 40px;
        }
        
        .pagination-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
            background: linear-gradient(45deg, #495057, #343a40);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #adb5bd;
        }
        
        .pagination-btn.active {
            background: linear-gradient(45deg, #007bff, #0056b3);
        }
        
        .page-input-container {
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
            font-weight: 500;
        }
        
        .page-input {
            width: 50px;
            padding: 4px 8px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .page-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .per-page-select {
            padding: 4px 8px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-weight: 500;
            cursor: pointer;
        }
        
        .pagination-info {
            color: white;
            font-size: 0.9rem;
            margin: 0 10px;
        }
        
        .pagination-bottom {
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            padding: 15px;
            margin: 20px -20px -20px -20px;
            border-radius: 0 0 15px 15px;
        }
        
        .pagination-bottom .pagination-container {
            justify-content: center;
        }
        
        .pagination-bottom .pagination-btn {
            background: linear-gradient(45deg, #495057, #6c757d);
        }
        
        .pagination-bottom .page-input {
            background: white;
            color: #333;
            border-color: #dee2e6;
        }

        .story-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .story-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .story-table th {
            background: linear-gradient(45deg, #495057, #6c757d);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
            position: relative;
        }

        .story-table th:hover {
            background: linear-gradient(45deg, #343a40, #495057);
        }

        .story-table th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            opacity: 0.6;
        }

        .story-table th.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        .story-table th.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .story-table tbody {
            max-height: 60vh;
            overflow-y: auto;
        }

        .story-row {
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .story-row:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        .story-row.expanded {
            background: #e3f2fd;
        }

        .story-row td {
            padding: 12px;
            vertical-align: middle;
        }

        .story-index {
            font-weight: bold;
            color: #495057;
            width: 60px;
        }

        .story-title {
            font-weight: bold;
            color: #2c3e50;
            max-width: 200px;
        }

        .story-author {
            color: #6c757d;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .story-rating {
            background: linear-gradient(45deg, #ffc107, #ff8c00);
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
            min-width: 45px;
            text-align: center;
        }

        .story-votes {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .story-size {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .story-date {
            color: #6c757d;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .story-details {
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            padding: 20px;
        }

        .story-synopsis {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #495057;
            font-style: italic;
        }

        .story-codes {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .story-code-tag {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .story-code-tag:hover {
            transform: scale(1.1);
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .scroll-container {
            max-height: 65vh;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar styling */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Story Filter & Browser</h1>
            <p>FetLibrary</p>
        </div>
        
        <div id="loading" class="loading">
            <p>Lade Story-Datenbank...</p>
        </div>
        
        <div id="main-content" class="main-content" style="display: none;">
            <div class="filter-panel">
                <div class="filter-controls">
                    <button class="add-filter-btn" onclick="addFilterSet()">
                        ➕ Filter-Set hinzufügen
                    </button>
                    <div class="save-load-controls">
                        <button class="save-btn" onclick="saveFilters(event)">💾 Speichern</button>
                        <button class="load-btn" onclick="loadFilters(event)">📂 Laden</button>
                        <button class="clear-btn" onclick="clearAllFilters()">🗑️ Alle löschen</button>
                    </div>
                </div>
                <div id="filter-container"></div>
            </div>
            
            <div class="results-panel">
                <div class="results-header">
                    <div class="results-header-top">
                        <div class="results-count" id="results-count">0 von 0 Stories</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 0.9rem;">Zeige:</span>
                            <select class="per-page-select" id="per-page-select" onchange="changePerPage(this.value)">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="all">Alle</option>
                            </select>
                        </div>
                    </div>
                    <div class="pagination-container" id="pagination-top"></div>
                </div>
                
                <div class="scroll-container">
                    <div class="story-table">
                        <table>
                            <thead>
                                <tr>
                                    <th class="sortable" onclick="sortTable('index', event)">Index</th>
                                    <th class="sortable" onclick="sortTable('title', event)">Titel</th>
                                    <th class="sortable" onclick="sortTable('author', event)">Autor</th>
                                    <th class="sortable" onclick="sortTable('rating_score', event)">Rating</th>
                                    <th class="sortable" onclick="sortTable('rating_votes', event)">Votes</th>
                                    <th class="sortable" onclick="sortTable('size_kb', event)">Size (KB)</th>
                                    <th class="sortable" onclick="sortTable('date_iso', event)">Date Added</th>
                                </tr>
                            </thead>
                            <tbody id="story-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="pagination-bottom">
                    <div class="pagination-container" id="pagination-bottom"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let allStories = [];
        let allCodes = [];
        let filteredStories = [];
        let filterSets = [];
        let filterSetCounter = 0;
        let currentSort = { column: 'index', direction: 'asc' };
        let expandedRows = new Set();
        let isInitializing = false;

        // Helper functions for date handling
        function parseDate(value) {
            if (!value) return new Date(0);
            const normalized = value.replace(/\./g, '-');
            const parts = normalized.split('-');
            if (parts[0].length === 4) {
                return new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);
            }
            return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
        }

        function formatDate(value) {
            if (!value) return '';
            const parts = value.includes('.') ? value.split('.') : value.split('-');
            if (parts[0].length === 4) {
                return `${parts[0]}.${parts[1]}.${parts[2]}`;
            }
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }

        // Pagination Variablen
        let currentPage = 1;
        let storiesPerPage = 50;
        let totalPages = 1;

        function changePerPage(value) {
            storiesPerPage = value === 'all'
                ? (filteredStories.length || allStories.length)
                : parseInt(value, 10);
            currentPage = 1;
            updateStoryTable();
            renderPagination();
        }

        // Daten laden beim Start
        async function loadData() {
            try {
                // Codes laden
                const codesResponse = await fetch('https://lib.grass-kassel.de/adv/codes.csv?v=' + Date.now());
                const codesText = await codesResponse.text();
                const codesData = Papa.parse(codesText, {
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true
                });
                allCodes = codesData.data;

                // Stories laden
                const storiesResponse = await fetch('https://lib.grass-kassel.de/adv/stories.csv?v=' + Date.now());
                const storiesText = await storiesResponse.text();
                const storiesData = Papa.parse(storiesText, {
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true,
                    dynamicTyping: true
                });
                allStories = storiesData.data;

                // UI initialisieren
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                
                // Initialisierung starten
                isInitializing = true;
                
                // Versuche gespeicherte Filter zu laden
                const hasLoadedFilters = tryLoadSavedFilters();
                
                // Wenn keine Filter geladen wurden, ersten Filter-Set erstellen
                if (!hasLoadedFilters) {
                    addFilterSet();
                }
                
                // Initialisierung abgeschlossen
                isInitializing = false;
                
                // Filter anwenden
                applyFilters();
                
            } catch (error) {
                console.error('Fehler beim Laden der Daten:', error);
                document.getElementById('loading').innerHTML = 
                    '<p style="color: #dc3545;">❌ Fehler beim Laden der CSV-Dateien. Bitte prüfen Sie die Verbindung.</p>';
            }
        }

        // Versuche gespeicherte Filter zu laden (ohne Alert)
        function tryLoadSavedFilters() {
            try {
                if (typeof(Storage) === "undefined") {
                    return false;
                }
                
                const savedData = localStorage.getItem('storyFilters');
                if (!savedData) {
                    return false;
                }
                
                const filterData = JSON.parse(savedData);
                
                // Gespeicherte Filter wiederherstellen
                filterSetCounter = filterData.filterSetCounter || 0;
                
                filterData.filterSets.forEach((savedFilterSet, index) => {
                    const filterSet = {
                        id: savedFilterSet.id,
                        logic: savedFilterSet.logic,
                        codes: savedFilterSet.codes || {},
                        betweenLogic: savedFilterSet.betweenLogic
                    };
                    
                    // betweenLogic dem vorherigen FilterSet zuweisen (für Connector)
                    if (index > 0 && savedFilterSet.betweenLogic) {
                        filterSets[index - 1].betweenLogic = savedFilterSet.betweenLogic;
                    }
                    
                    filterSets.push(filterSet);
                    createFilterSetHTML(filterSet, savedFilterSet);
                });
                
                // Logic Connectors wiederherstellen
                rebuildLogicConnectors();
                
                return filterSets.length > 0;
                
            } catch (error) {
                console.warn('Fehler beim automatischen Laden der Filter:', error);
                localStorage.removeItem('storyFilters');
                return false;
            }
        }

        // Filter-Set hinzufügen
        function addFilterSet() {
            filterSetCounter++;
            const filterId = `filter-set-${filterSetCounter}`;
            
            const filterSet = {
                id: filterId,
                logic: 'AND',
                codes: {},
                betweenLogic: 'AND'  // Standard-Wert für Connector
            };
            
            // Bei mehreren Sets: betweenLogic zum vorherigen Set hinzufügen
            if (filterSets.length > 0) {
                filterSets[filterSets.length - 1].betweenLogic = 'AND';
            }
            
            filterSets.push(filterSet);

            const filterContainer = document.getElementById('filter-container');
            
            // Logic Connector hinzufügen (außer beim ersten Filter)
            if (filterSets.length > 1) {
                const connector = document.createElement('div');
                connector.className = 'logic-connector';
                connector.id = `connector-${filterSets.length - 1}`;
                connector.innerHTML = `
                    <span style="margin-right: 10px;">Verknüpfung:</span>
                    <select onchange="updateFilterLogic(this, ${filterSets.length - 2})" class="logic-dropdown" style="background: #fff; color: #000; border: 2px solid #dee2e6; padding: 8px 15px;">
                        <option value="AND">UND (beide Sets)</option>
                        <option value="OR">ODER (eines der Sets)</option>
                    </select>
                `;
                filterContainer.appendChild(connector);
            }

            createFilterSetHTML(filterSet);
            applyFilters();
        }

        // Filter-Set entfernen
        function removeFilterSet(filterId) {
            if (filterSets.length <= 1) {
                alert('Mindestens ein Filter-Set muss vorhanden bleiben.');
                return;
            }

            const element = document.getElementById(filterId);
            if (element) {
                element.remove();
            }

            // Filter-Set aus Array entfernen
            filterSets = filterSets.filter(fs => fs.id !== filterId);

            // Logic Connectors neu aufbauen
            rebuildLogicConnectors();
            
            applyFilters();
        }

        // Logic Connectors neu aufbauen
        function rebuildLogicConnectors() {
            const container = document.getElementById('filter-container');
            
            // Alle alten Connectors entfernen
            const connectors = container.querySelectorAll('.logic-connector');
            connectors.forEach(c => c.remove());

            // Neue Connectors zwischen allen Filter-Sets einfügen
            const filterElements = container.querySelectorAll('.filter-set');
            for (let i = 1; i < filterElements.length; i++) {
                const connector = document.createElement('div');
                connector.className = 'logic-connector';
                connector.id = `connector-${i}`;
                connector.innerHTML = `
                    <span style="margin-right: 10px;">Verknüpfung:</span>
                    <select onchange="updateFilterLogic(this, ${i - 1})" class="logic-dropdown" style="background: #fff; color: #000; border: 2px solid #dee2e6; padding: 8px 15px;">
                        <option value="AND" ${filterSets[i-1]?.betweenLogic === 'AND' ? 'selected' : ''}>UND (beide Sets)</option>
                        <option value="OR" ${filterSets[i-1]?.betweenLogic === 'OR' ? 'selected' : ''}>ODER (eines der Sets)</option>
                    </select>
                `;
                container.insertBefore(connector, filterElements[i]);
            }
        }

        // Filter-Logic zwischen Sets aktualisieren
        function updateFilterLogic(select, index) {
            if (filterSets[index]) {
                filterSets[index].betweenLogic = select.value;
                applyFilters();
            }
        }

        // Filter-Set Logic aktualisieren
        function updateFilterSetLogic(filterId, logic) {
            const filterSet = filterSets.find(fs => fs.id === filterId);
            if (filterSet) {
                filterSet.logic = logic;
                applyFilters();
            }
        }

        // Code-Status umschalten
        function toggleCode(filterId, codeId, element) {
            const states = ['maybe', 'yes', 'no'];
            const currentState = element.getAttribute('data-state');
            const currentIndex = states.indexOf(currentState);
            const nextIndex = (currentIndex + 1) % states.length;
            const nextState = states[nextIndex];

            // Visual Update
            element.className = `code-btn ${nextState}`;
            element.setAttribute('data-state', nextState);

            // Filter-Set Update
            const filterSet = filterSets.find(fs => fs.id === filterId);
            if (filterSet) {
                if (nextState === 'maybe') {
                    delete filterSet.codes[codeId];
                } else {
                    filterSet.codes[codeId] = nextState;
                }
            }

            applyFilters();
        }

        // Filter anwenden
        function applyFilters() {
            filteredStories = allStories.filter(story => {
                // Story-Codes sammeln
                const storyCodes = new Set();
                for (let i = 1; i <= story.codes_count; i++) {
                    const code = story[`code_${i}`];
                    if (code) storyCodes.add(code);
                }

                // Filter-Sets auswerten
                const filterResults = filterSets.map(filterSet => {
                    const conditions = Object.entries(filterSet.codes);
                    if (conditions.length === 0) return true; // Leerer Filter = alle durchlassen

                    if (filterSet.logic === 'AND') {
                        return conditions.every(([code, state]) => {
                            const hasCode = storyCodes.has(code);
                            if (state === 'yes') return hasCode;
                            if (state === 'no') return !hasCode;
                            return true; // maybe
                        });
                    } else { // OR
                        return conditions.some(([code, state]) => {
                            const hasCode = storyCodes.has(code);
                            if (state === 'yes') return hasCode;
                            if (state === 'no') return !hasCode;
                            return false; // maybe bei OR ignorieren
                        });
                    }
                });

                // Zwischen Filter-Sets verknüpfen
                if (filterResults.length === 0) return true;
                if (filterResults.length === 1) return filterResults[0];

                let result = filterResults[0];
                for (let i = 1; i < filterResults.length; i++) {
                    const logic = filterSets[i-1]?.betweenLogic || 'AND';
                    if (logic === 'AND') {
                        result = result && filterResults[i];
                    } else {
                        result = result || filterResults[i];
                    }
                }

                return result;
            });

            currentPage = 1;
            renderPagination();
            updateStoryTable();

            // Auto-Save (nur wenn nicht in Initialisierung und Filter existieren)
            if (!isInitializing && filterSets.length > 0) {
                autoSaveFilters();
            }
        }

        // Auto-Save Funktion
        function autoSaveFilters() {
            try {
                const filterData = {
                    filterSets: filterSets.map(fs => ({
                        id: fs.id,
                        logic: fs.logic,
                        codes: fs.codes,
                        betweenLogic: fs.betweenLogic
                    })),
                    filterSetCounter: filterSetCounter,
                    timestamp: new Date().toISOString()
                };
                
                if (typeof Storage !== "undefined") {
                    localStorage.setItem('storyFilters', JSON.stringify(filterData));
                }
            } catch (error) {
                console.warn('Auto-Save fehlgeschlagen:', error);
            }
        }

        // Story-Tabelle aktualisieren
        function updateStoryTable() {
            const tbody = document.getElementById('story-table-body');
            const count = document.getElementById('results-count');

            // Sortieren
            const sorted = [...filteredStories].sort((a, b) => {
                let aVal = a[currentSort.column];
                let bVal = b[currentSort.column];

                // Spezielle Behandlung für verschiedene Datentypen
                if (currentSort.column === 'date_iso') {
                    aVal = parseDate(aVal);
                    bVal = parseDate(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const start = (currentPage - 1) * storiesPerPage;
            const end = start + storiesPerPage;
            const pageStories = sorted.slice(start, end);
            const total = filteredStories.length;
            const rangeStart = total === 0 ? 0 : start + 1;
            const rangeEnd = Math.min(end, total);

            count.textContent = `${rangeStart}-${rangeEnd} von ${total} Stories`;

            tbody.innerHTML = pageStories.map(story => {
                const isExpanded = expandedRows.has(story.index);
                
                let mainRow = `
                    <tr class="story-row ${isExpanded ? 'expanded' : ''}" onclick="toggleStoryDetails(event, ${story.index})">
                        <td class="story-index">${story.index}</td>
                        <td class="story-title">${story.title}</td>
                        <td class="story-author">${story.author || 'Unbekannt'}</td>
                        <td><span class="story-rating">${story.rating_score || 'N/A'}</span></td>
                        <td class="story-votes">${story.rating_votes || 0}</td>
                        <td class="story-size">${story.size_kb || 0}</td>
                        <td class="story-date">${formatDate(story.date_iso)}</td>
                    </tr>
                `;

                if (isExpanded) {
                    // Story-Codes sammeln
                    const codes = [];
                    for (let i = 1; i <= story.codes_count; i++) {
                        const code = story[`code_${i}`];
                        if (code) codes.push(code);
                    }

                    const detailsRow = `
                        <tr class="story-row expanded">
                            <td colspan="7">
                                <div class="story-details">
                                    <div class="story-synopsis">
                                        <strong>Synopsis:</strong> ${story.synopsis || 'Keine Beschreibung verfügbar.'}
                                    </div>
                                    <div>
                                        <strong>Story Codes (${story.codes_count}):</strong>
                                        <div class="story-codes">
                                            ${codes.map(code => `<span class="story-code-tag">${code}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <a href="https://lib.grass-kassel.de/adv/detail2.html?file=${story.html}" target="_blank" 
                                           style="color: #007bff; text-decoration: none; font-weight: bold;">
                                           📖 Story öffnen
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return mainRow + detailsRow;
                }

                return mainRow;
            }).join('');
        }

        function renderPagination() {
            totalPages = Math.ceil(filteredStories.length / storiesPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const top = document.getElementById('pagination-top');
            const bottom = document.getElementById('pagination-bottom');
            [top, bottom].forEach(container => {
                container.innerHTML = '';

                const createBtn = (label, target) => {
                    const btn = document.createElement('button');
                    btn.textContent = label;
                    btn.className = 'pagination-btn';
                    btn.disabled = target < 1 || target > totalPages || target === currentPage;
                    btn.addEventListener('click', () => goToPage(target));
                    container.appendChild(btn);
                };

                createBtn('Zurück', currentPage - 1);
                createBtn('Erste', 1);
                createBtn('-10', currentPage - 10);
                createBtn('-1', currentPage - 1);

                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'page-input';
                input.value = currentPage;
                input.min = 1;
                input.max = totalPages;
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        const page = parseInt(input.value, 10);
                        goToPage(page);
                    }
                });
                input.addEventListener('change', () => {
                    const page = parseInt(input.value, 10);
                    goToPage(page);
                });
                container.appendChild(input);

                createBtn('+1', currentPage + 1);
                createBtn('+10', currentPage + 10);
                createBtn('Letzte', totalPages);
                createBtn('Weiter', currentPage + 1);
            });
        }

        function goToPage(page) {
            if (isNaN(page) || page < 1 || page > totalPages) return;
            currentPage = page;
            updateStoryTable();
            renderPagination();
        }

        // Story-Details ein-/ausklappen (mit Event-Stop)
        function toggleStoryDetails(event, storyIndex) {
            event.stopPropagation();
            
            if (expandedRows.has(storyIndex)) {
                expandedRows.delete(storyIndex);
            } else {
                expandedRows.add(storyIndex);
            }
            updateStoryTable();
        }

        // Tabelle sortieren
        function sortTable(column, evt) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Header-Styling aktualisieren
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const clickedHeader = evt.target;
            clickedHeader.classList.add(`sort-${currentSort.direction}`);

            updateStoryTable();
        }

        // Filter speichern (manuell)
        function saveFilters(evt) {
            try {
                const filterData = {
                    filterSets: filterSets.map(fs => ({
                        id: fs.id,
                        logic: fs.logic,
                        codes: fs.codes || {},
                        betweenLogic: fs.betweenLogic
                    })),
                    filterSetCounter: filterSetCounter,
                    timestamp: new Date().toISOString()
                };
                
                // In Browser-Speicher speichern (konsistentes Format)
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('storyFilters', JSON.stringify(filterData));
                }
                
                // Erfolgs-Feedback
                const btn = evt.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Gespeichert!';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #6f42c1, #8a2be2)';
                }, 2000);
                
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Filter!');
            }
        }

        // Filter laden (manuell)
        function loadFilters(evt) {
            try {
                if (typeof(Storage) === "undefined") {
                    alert('LocalStorage nicht verfügbar!');
                    return;
                }
                
                const savedData = localStorage.getItem('storyFilters');
                if (!savedData) {
                    alert('Keine gespeicherten Filter gefunden!');
                    return;
                }
                
                const filterData = JSON.parse(savedData);
                
                // Alle aktuellen Filter löschen
                clearAllFilters(false);
                
                // Gespeicherte Filter wiederherstellen
                filterSetCounter = filterData.filterSetCounter || 0;
                
                filterData.filterSets.forEach(savedFilterSet => {
                    const filterSet = {
                        id: savedFilterSet.id,
                        logic: savedFilterSet.logic,
                        codes: savedFilterSet.codes || {},
                        betweenLogic: savedFilterSet.betweenLogic
                    };
                    filterSets.push(filterSet);
                    createFilterSetHTML(filterSet, savedFilterSet);
                });
                
                // Nach dem Laden alle Logic Connectors neu aufbauen
                rebuildLogicConnectors();
                
                // Filter anwenden
                applyFilters();
                
                // Sicherstellen, dass mindestens ein Filter-Set existiert
                if (filterSets.length === 0) {
                    addFilterSet();
                }
                
                // Erfolgs-Feedback
                const btn = evt.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Geladen!';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'linear-gradient(45deg, #6f42c1, #8a2be2)';
                }, 2000);
                
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                localStorage.removeItem('storyFilters');
                alert('Fehler beim Laden der Filter! Speicher wurde zurückgesetzt.');
            }
        }

        // Alle Filter löschen
        function clearAllFilters(showConfirm = true) {
            if (showConfirm && !confirm('Alle Filter-Sets löschen?')) {
                return;
            }
            
            // Alle Filter-Sets entfernen
            document.getElementById('filter-container').innerHTML = '';
            filterSets = [];
            filterSetCounter = 0;
            expandedRows.clear();
            
            // Browser-Speicher löschen
            if (typeof(Storage) !== "undefined") {
                localStorage.removeItem('storyFilters');
            }
            
            // Ersten Filter-Set hinzufügen (nur bei manueller Löschung)
            if (showConfirm) {
                addFilterSet();
                applyFilters();
            }
        }

        // Hilfsfunktion zum Erstellen der Filter-Set HTML
        function createFilterSetHTML(filterSet, savedFilterSet = null) {
            const filterContainer = document.getElementById('filter-container');
            
            // Filter-Set HTML erstellen
            const filterDiv = document.createElement('div');
            filterDiv.className = 'filter-set';
            filterDiv.id = filterSet.id;
            
            let subcategoriesHTML = '';
            const groupedCodes = {};
            
            // Codes nach Subkategorien gruppieren
            allCodes.forEach(code => {
                if (!groupedCodes[code['sub category']]) {
                    groupedCodes[code['sub category']] = [];
                }
                groupedCodes[code['sub category']].push(code);
            });

            // HTML für Subkategorien erstellen
            Object.keys(groupedCodes).forEach(subcategory => {
                subcategoriesHTML += `
                    <div class="subcategory">
                        <div class="subcategory-title">${subcategory}</div>
                        <div class="code-buttons">
                            ${groupedCodes[subcategory].map(code => {
                                const savedState = (savedFilterSet && savedFilterSet.codes && savedFilterSet.codes[code.code]) || 
                                                  (filterSet.codes && filterSet.codes[code.code]) || 
                                                  'maybe';
                                return `
                                    <div class="code-btn ${savedState}" 
                                         onclick="toggleCode('${filterSet.id}', '${code.code}', this)"
                                         data-state="${savedState}">
                                        ${code.code}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            const filterNumber = filterSet.id.split('-')[2];
            filterDiv.innerHTML = `
                <div class="filter-set-header">
                    <div class="filter-set-title">Filter-Set ${filterNumber}</div>
                    <select class="logic-dropdown" onchange="updateFilterSetLogic('${filterSet.id}', this.value)" title="Wie werden die Bedingungen in diesem Set verknüpft?">
                        <option value="AND" ${filterSet.logic === 'AND' ? 'selected' : ''}>UND (alle Bedingungen)</option>
                        <option value="OR" ${filterSet.logic === 'OR' ? 'selected' : ''}>ODER (eine Bedingung)</option>
                    </select>
                    <button class="reset-filter-btn" onclick="resetFilterSet('${filterSet.id}')" title="Alle auf Vielleicht zurücksetzen" style="background: #ffc107; color: #000; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">↻</button>
                    <button class="remove-filter-btn" onclick="removeFilterSet('${filterSet.id}')">❌</button>
                </div>
                <div class="filter-set-content">
                    ${subcategoriesHTML}
                </div>
            `;

            filterContainer.appendChild(filterDiv);
        }

        // Filter-Set zurücksetzen (alle Codes auf "maybe")
        function resetFilterSet(filterId) {
            // Filter-Set finden und Codes löschen
            const filterSet = filterSets.find(fs => fs.id === filterId);
            if (filterSet) {
                filterSet.codes = {};
            }
            
            // Alle Code-Buttons in diesem Filter-Set zurücksetzen
            const filterElement = document.getElementById(filterId);
            if (filterElement) {
                const codeButtons = filterElement.querySelectorAll('.code-btn');
                codeButtons.forEach(btn => {
                    btn.className = 'code-btn maybe';
                    btn.setAttribute('data-state', 'maybe');
                });
            }
            
            // Filter anwenden
            applyFilters();
            
            // Visuelles Feedback
            const resetBtn = filterElement.querySelector('.reset-filter-btn');
            if (resetBtn) {
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '✓';
                resetBtn.style.background = '#28a745';
                resetBtn.style.color = '#fff';
                setTimeout(() => {
                    resetBtn.innerHTML = originalText;
                    resetBtn.style.background = '#ffc107';
                    resetBtn.style.color = '#000';
                }, 1000);
            }
        }

        // App beim Laden starten
        window.addEventListener('load', loadData);
    </script>
</body>
</html>